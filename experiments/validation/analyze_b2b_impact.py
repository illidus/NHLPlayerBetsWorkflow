
import duckdb
import pandas as pd

pd.set_option('display.max_columns', None)
pd.set_option('display.width', 1000)

db_path = "data/db/nhl_backtest.duckdb"
con = duckdb.connect(db_path)

query = """
WITH team_games AS (
    SELECT home_team as team, game_date, game_id FROM dim_games
    UNION ALL
    SELECT away_team as team, game_date, game_id FROM dim_games
),
team_rest_calc AS (
    SELECT
        team,
        game_date,
        game_id,
        CAST(game_date AS DATE) - LAG(CAST(game_date AS DATE)) OVER (PARTITION BY team ORDER BY game_date) as days_since_last
    FROM team_games
),
team_rest AS (
    SELECT 
        team,
        game_date,
        game_id,
        CASE 
            WHEN days_since_last = 1 THEN 'B2B'
            WHEN days_since_last >= 2 THEN 'Rested'
            ELSE 'Unknown' 
        END as rest_status
    FROM team_rest_calc
),
-- Calculate Stats per Team per Game (Goals For, SOG For)
game_team_stats AS (
    SELECT
        game_id,
        team,
        SUM(goals) as gf,
        SUM(sog) as sf
    FROM fact_skater_game_all
    GROUP BY game_id, team
),
-- Join to identify Opponent Stats (SA, Goals Against) for the perspective of the 'team'
game_matchups AS (
    -- For each game, link Team to Opponent
    SELECT
        g.game_id,
        g.game_date,
        g.home_team as team,
        g.away_team as opp_team
    FROM dim_games g
    UNION ALL
    SELECT
        g.game_id,
        g.game_date,
        g.away_team as team,
        g.home_team as opp_team
    FROM dim_games g
),
matchup_stats AS (
    SELECT
        gm.game_id,
        gm.game_date,
        gm.team,
        gm.opp_team,
        tr.rest_status as opp_rest_status,
        opp_stats.sf as opp_sa,   -- Opponent's SF is Team's SA (Shots Against). Wait. 
                                  -- If we are analyzing 'Opponent Fatigue', we want to know if the Opponent *allows* more shots.
                                  -- So we want Opponent's SA.
                                  -- Opponent's SA = Team's SF.
        my_stats.sf as team_sf,   -- This is shots generated by 'team' against 'opp_team'.
        my_stats.gf as team_gf    -- Goals generated by 'team' against 'opp_team'.
    FROM game_matchups gm
    JOIN team_rest tr ON gm.opp_team = tr.team AND gm.game_date = tr.game_date
    JOIN game_team_stats opp_stats ON gm.game_id = opp_stats.game_id AND gm.opp_team = opp_stats.team
    JOIN game_team_stats my_stats ON gm.game_id = my_stats.game_id AND gm.team = my_stats.team
),
-- Now bring in the Bets
bets_enriched AS (
    SELECT
        b.market,
        b.line,
        b.actual_value,
        b.profit,
        b.stake,
        ms.opp_rest_status,
        ms.team_sf, -- Shots against the opponent
        ms.team_gf  -- Goals against the opponent
    FROM fact_backtest_v2_clean b
    JOIN fact_skater_game_all s ON b.player_id = s.player_id AND b.game_date = s.game_date
    JOIN matchup_stats ms ON s.game_id = ms.game_id AND s.team = ms.team
    WHERE b.market IN ('SOG', 'GOALS', 'POINTS', 'ASSISTS')
    -- Filter out Unknown rest (start of season)
    AND ms.opp_rest_status IN ('B2B', 'Rested')
)

SELECT
    market,
    opp_rest_status,
    COUNT(*) as bet_count,
    ROUND(AVG(line), 2) as avg_line,
    ROUND(AVG(actual_value), 2) as avg_actual_player_stat,
    ROUND(AVG(team_sf), 2) as avg_team_shots_on_opponent,
    ROUND(SUM(team_gf) / SUM(team_sf), 4) as global_shooting_pct,
    ROUND(SUM(profit), 2) as total_profit,
    ROUND(SUM(profit) / SUM(stake) * 100, 2) as roi_pct
FROM bets_enriched
GROUP BY market, opp_rest_status
ORDER BY market, opp_rest_status
"""

print("Running Analysis...")
df = con.execute(query).df()
print(df)

print("\n--- Summary Analysis ---")
# Pivot for easier reading
pivot = df.pivot(index='market', columns='opp_rest_status', values=['avg_team_shots_on_opponent', 'global_shooting_pct', 'avg_line', 'roi_pct'])
print(pivot)
